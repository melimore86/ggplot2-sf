---
title: "Drawing beautiful maps programmatically with R, sf and ggplot2"
author: "Mel Moreno and Mathieu Basille"
output:
  html_document:
    fig_caption: no
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: '2'
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(
    results = "hide",
    warning = FALSE, 
    message = FALSE,
    cache = TRUE)
## This is just to "pre-load" all packages, and prevent the startup
## messages to show
library("devtools")
library("ggplot2")
library("sf")
library("rworldmap")
library("rworldxtra")
library("viridis")
library("legendMap")
library("tools")
library("ggmap")

## library("ggsn")
## library("ggthemes")
## library("maps")
## library("maptools")
## library("rgdal")
## library("rgeos")
## library("rgdal")
## library("sp")
## library("tidyverse")
## library("dplyr")
```


## Adding additional layers: an example with points and polygons

In the previous section, we presented general concepts with a map with little information (country borders only). The modular approach of `ggplot2` allows to successively add additional layers, for instance study sites or administrative delineations, as will be illustrated in this section.

## Point data (`geom_point` and `geom_sf`)

We start by defining two study sites, according to their longitude and latitude, stored in a `data.frame`:

```{r points-sites}
(sites <- data.frame(longitude = c(-80.144005, -80.109), latitude = c(26.479005, 26.830)))
```

The easiest way to add point coordinates is with the general-purpose
function `geom_point`, which works on any X/Y coordinates,
of regular data points (i.e. not geographic). As such, we can adjust
all characteristics of points (e.g. color of the outline and the
filling, shape, size, etc.), for all points, or using grouping from
the data (i.e defining their "aesthetics"). In this example, we add
the two points as diamonds (`shape = 23`), filled in dark red (`fill =
"darkred"`) and of bigger size (`size = 4`):

```{r points-plot}
ggplot(data = world) +
    geom_sf() +
    geom_point(data = sites, aes(x = longitude, y = latitude), size = 2, shape = 23, fill = "darkred") +
    coord_sf(xlim = c(-89.15, -76.12), ylim = c(24.65, 33.97), expand = FALSE)
```

A better, more flexible alternative is to use the power of `sf`: Converting the data frame to a `sf` object allows to rely on `sf` to handle on the fly the coordinate system (both projection and extent), which can be very useful if the two objects (here world map, and sites) are not in the same projection. To achieve the same result, the projection (here WGS84) has to be a priori defined in the `sf` object:

```{r points-sf}
(sites <- st_as_sf(sites, coords = c("longitude", "latitude"), crs = 4326, agr = "constant"))

ggplot(data = world) +
    geom_sf() +
    geom_sf(data = sites, size = 2, shape = 23, fill = "darkred") +
    coord_sf(xlim = c(-89.15, -76.12), ylim = c(24.65, 33.97), expand = FALSE)
```

Note that in this case, `coord_sf` has to be called after all `geom_sf` calls, as to supersede any former input.

## State data (`geom_sf`)

It would be informative to add finer administrative information on top of the previous map, starting with state borders and names. The package `maps` (which is automatically installed and loaded with `ggplot2`) provides maps of the USA, with state and county borders, that can be retrieved and converted as `sf` objects:

```{r coord_getState}
states <- st_as_sf(map("state", plot = FALSE, fill = TRUE))
head(states)
```

State names are part of this data, as the `ID` variable. A simple (but not necessarily optimal) to add state name is to compute the centroid of each state polygon as the coordinates where to draw their names. Centroids are computed with the function `st_centroid`, their coordinates extracted with `st_coordinates`, both from the package `sf`, and attached to the state object:


```{r coordmap_statenames}
states <- cbind(states, st_coordinates(st_centroid(states)))
```

Note the warning, which basically says that centroid coordinates using longitude/latitude data (i.e. WGS84) are not correct, which is perfectly fine for our drawing purposes. State names, which are not capitalized in the data from `maps`, can be changed to title case using the function `toTitleCase` from the package `tools`:

```{r coordmap_capitalizing}
library("tools")
states$ID <- toTitleCase(states$ID)
head(states)
```

To continue adding to the map, state data is directly plotted as an additional `sf` layer using `geom_sf`. In addition, state names will be added using `geom_text`, declaring coordinates on the X-axis and Y-axis, as well as the label (from `ID`), and a relatively big font size.


```{r coord_states}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = sites, size = 2, shape = 23, fill = "darkred") +
    geom_sf(data = states, fill = NA) + 
    coord_sf(xlim = c(-89.15, -76.12), ylim = c(24.65, 33.97), expand = FALSE) +
    geom_text(data = states, aes(X, Y, label = ID), size = 5)

```

## County data (`geom_sf`)

County data are also available from the package `maps`, and can be retrieved with the same approach as for state data. This time, only counties from Florida are retained:

```{r coord_county}
counties <- st_as_sf(map("county", plot = FALSE, fill = TRUE))
counties <- subset(counties, grepl("florida", counties$ID))
head(counties)
```


County lines can now be added in a very simple way, using a gray outline:

```{r county_line}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = sites, size = 2, shape = 23, fill = "darkred") +
    geom_sf(data = counties, fill = NA, color = gray(.5)) +
    geom_sf(data = states, fill = NA) + 
    coord_sf(xlim = c(-89.15, -76.12), ylim = c(24.65, 33.97), expand = FALSE) +
    geom_text(data = states, aes(X, Y, label = ID), size = 5)

```

## City names 

We would like to add the main Florida cities to our map, as opposed to all of the cities in Florida because it might make it look very cluttered. You can use this general code for any city in the United States. You could change the region to the state name, which is lowercase. The function `geocode` requires the package `ggmap` .

```{r featmap_cities}
library(ggmap)

flcities <- data.frame(State=rep("florida",7), 
                         City=c("Miami", "Fort Lauderdale", "Orlando", "Gainesville", "Tallahassee", "Tampa","Jacksonville"))

flcities<-cbind(geocode(as.character(flcities$City)),flcities)

```

## Final map
For the final map, the same color theme as before is used, state names are slightly adjusted (using the argument `nudge_y` to move them South) and plotted in filled boxes, and titles, subtitles, axis labels, and a scale bar are added to the map:

```{r coormap_final}

ggplot(data = world) +
    geom_sf(fill = "cornsilk") +
    geom_sf(data = sites, size = 2, shape = 23, fill = "darkred") +
    geom_sf(data = counties, fill = NA, color = gray(.5)) +
    geom_sf(data = states, fill = NA) + 
  geom_text(aes(x=lon, y=lat, label = City), data = flcities, size = 3.9, nudge_y =.18, col = "black", check_overlap = TRUE,fontface = "bold") +
    coord_sf(xlim = c(-89.15, -76.12), ylim = c(24.65, 33.97), expand = FALSE) +
    scale_bar(lon = -88.66, lat =25,distance_lon = 150, distance_lat = 25, distance_legend = 100, dist_unit = "km", arrow_length=75, arrow_distance=150, arrow_north_size =6, orientation= TRUE,legend_size=2) +
    geom_label(data = states, aes(X, Y, label = ID), size = 5, fontface = "bold", nudge_y = -.5) +
    xlab("Longitude") + ylab("Latitude") +
    ggtitle ("Observation Sites", subtitle = "(2 sites in Palm Beach County, Florida)") +
    theme(panel.grid.major = element_line(color = gray(.5),
        linetype = "dashed", size = 0.5),
        panel.background = element_rect(fill = "lightskyblue1"))

```


This example fully demonstrates that adding layers on `ggplot2` is relatively straightforward, as long as the data is properly stored in an `sf` object. Adding additional layers would simply follow the same logic, with additional calls to `geom_sf` at the right place in the `ggplot2` sequence.

## Saving with ggsave

The final map now ready, it would be a good idea to save it. Using `ggsave` will allow a graphic to be saved in a variety of formats, including the most common PNG (raster bitmap) and PDF (vector graphics):

```{r featmap_ggsave, eval=FALSE}
ggsave("Floridamap.png")
ggsave("Floridamap.pdf")
```

# Helpful Resources

## PDFs for packages

-ggplot2 https://cran.r-project.org/web/packages/ggplot2/ggplot2.pdf http://ggplot2.tidyverse.org/reference/stat_ecdf.html

-sf https://cran.r-project.org/web/packages/sf/sf.pdf

-sp https://cran.r-project.org/web/packages/sp/sp.pdf

-CRAN https://cran.r-project.org/

-Viridis Color Palettes https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html

-Scale Bar https://rdrr.io/github/3wen/legendMap/man/scale_bar.html

## Links and various tutorials

-Global Choropleth, world interactive, rotating map

http://ellisp.github.io/blog/2017/06/04/military-gdp

-Ggplotly

http://www.alexejgossmann.com/salaries_by_school_plotly_viz/

-R studio colors

http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf

-Plotting side by side

https://ikashnitsky.github.io/2017/align-six-maps/

-Leaflet

https://cengel.github.io/rspatial/4_Mapping.nb.html

Points with gganimate http://blog.cultureofinsight.com/2017/06/building-dot-density-maps-with-uk-census-data-in-r/

-Symobls and Points http://www.sthda.com/english/wiki/r-plot-pch-symbols-the-different-point-shapes-available-in-r

-Themes http://ggplot2.tidyverse.org/reference/theme.html

-Two graphs with same legend

https://github.com/tidyverse/ggplot2/wiki/share-a-legend-between-two-ggplot2-graphs

Downloading Multiple Zipped files https://www.r-bloggers.com/batch-downloading-zipped-shapefiles-with-r/
